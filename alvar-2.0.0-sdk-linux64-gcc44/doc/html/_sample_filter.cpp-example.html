<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>SampleFilter.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>SampleFilter.cpp</h1><p>This is an example of how to use various filters: <em>FilterAverage</em>, <em>FilterMedian</em>, <em>FilterRunningAverage</em>, <em>FilterDoubleExponentialSmoothing</em> and <em>Kalman</em>.</p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &quot;cv.h&quot;</span>
<span class="preprocessor">#include &quot;highgui.h&quot;</span>
<span class="preprocessor">#include &lt;iostream&gt;</span>
<span class="preprocessor">#include &lt;cstdlib&gt;</span>
<span class="preprocessor">#include &lt;string&gt;</span>
<span class="preprocessor">#include &quot;<a class="code" href="_filter_8h.html" title="This file implements multiple filters.">Filter.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="_kalman_8h.html" title="This file implements a versatile Kalman filter.">Kalman.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="_platform_8h.html" title="This file implements generic platform specific methods.">Platform.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="_alvar_exception_8h.html" title="This file implements the ALVAR exception class.">AlvarException.h</a>&quot;</span>
<span class="keyword">using namespace </span>alvar;
<span class="keyword">using namespace </span>std;

<span class="keyword">const</span> <span class="keywordtype">int</span> res=320;

<span class="keywordtype">void</span> filter_none(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y, <span class="keywordtype">double</span> *fx, <span class="keywordtype">double</span> *fy) {
    *fx = x; *fy = y;
}

<span class="keywordtype">void</span> filter_average(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y, <span class="keywordtype">double</span> *fx, <span class="keywordtype">double</span> *fy) {
    <span class="keyword">static</span> <a name="_a0"></a><a class="code" href="classalvar_1_1_filter_average.html" title="FilterAverage provides an average filter">FilterAverage</a> ax(30);
    <span class="keyword">static</span> <a class="code" href="classalvar_1_1_filter_average.html" title="FilterAverage provides an average filter">FilterAverage</a> ay(30);
    *fx = ax.next(x);
    *fy = ay.next(y);
}

<span class="keywordtype">void</span> filter_median(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y, <span class="keywordtype">double</span> *fx, <span class="keywordtype">double</span> *fy) {
    <span class="keyword">static</span> <a name="_a1"></a><a class="code" href="classalvar_1_1_filter_median.html" title="FilterMedian provides an median filter">FilterMedian</a> ax(30);
    <span class="keyword">static</span> <a class="code" href="classalvar_1_1_filter_median.html" title="FilterMedian provides an median filter">FilterMedian</a> ay(30);
    *fx = ax.next(x);
    *fy = ay.next(y);
}

<span class="keywordtype">void</span> filter_running_average(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y, <span class="keywordtype">double</span> *fx, <span class="keywordtype">double</span> *fy) {
    <span class="keyword">static</span> <a name="_a2"></a><a class="code" href="classalvar_1_1_filter_running_average.html" title="FilterRunningAverage provides an weighted running average filter">FilterRunningAverage</a> ax(0.03);
    <span class="keyword">static</span> <a class="code" href="classalvar_1_1_filter_running_average.html" title="FilterRunningAverage provides an weighted running average filter">FilterRunningAverage</a> ay(0.03);
    *fx = ax.next(x);
    *fy = ay.next(y);
}

<span class="keywordtype">void</span> filter_des(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y, <span class="keywordtype">double</span> *fx, <span class="keywordtype">double</span> *fy) {
    <span class="keyword">static</span> <a name="_a3"></a><a class="code" href="classalvar_1_1_filter_double_exponential_smoothing.html" title="FilterDoubleExponentialSmoothing provides an weighted running average filter">FilterDoubleExponentialSmoothing</a> ax(0.03,0.01);
    <span class="keyword">static</span> <a class="code" href="classalvar_1_1_filter_double_exponential_smoothing.html" title="FilterDoubleExponentialSmoothing provides an weighted running average filter">FilterDoubleExponentialSmoothing</a> ay(0.03,0.01);
    *fx = ax.next(x);
    *fy = ay.next(y);
}

<span class="keywordtype">void</span> filter_kalman(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y, <span class="keywordtype">double</span> *fx, <span class="keywordtype">double</span> *fy) {
    <span class="keyword">static</span> <span class="keywordtype">bool</span> init=<span class="keyword">true</span>;
    <span class="keyword">static</span> <a name="_a4"></a><a class="code" href="classalvar_1_1_kalman_sensor.html" title="Kalman sensor implementation.">KalmanSensor</a> sensor(4,2); 
    <span class="keyword">static</span> <a name="_a5"></a><a class="code" href="classalvar_1_1_kalman.html" title="Kalman implementation.">Kalman</a> kalman(4); <span class="comment">// x, y, dx, dy</span>
    <span class="keywordflow">if</span> (init) {
        init = <span class="keyword">false</span>;
        <span class="comment">// H</span>
        cvZero(sensor.H);
        cvmSet(sensor.H, 0, 0, 1);
        cvmSet(sensor.H, 1, 1, 1);
        <span class="comment">// R</span>
        cvSetIdentity(sensor.R, cvScalar(10));
        <span class="comment">// F</span>
        cvSetIdentity(kalman.F);
        cvmSet(kalman.F, 0, 2, 1);
        cvmSet(kalman.F, 1, 3, 1);
        <span class="comment">// Q</span>
        cvmSet(kalman.Q, 0, 0, 0.0001);
        cvmSet(kalman.Q, 1, 1, 0.0001);
        cvmSet(kalman.Q, 2, 2, 0.000001);
        cvmSet(kalman.Q, 3, 3, 0.000001);
        <span class="comment">// P</span>
        cvSetIdentity(kalman.P, cvScalar(100));
    }
    cvmSet(sensor.z, 0, 0, x);
    cvmSet(sensor.z, 1, 0, y);
    kalman.predict_update(&amp;sensor, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(cv::getTickCount() / cv::getTickFrequency() * 1000));
    *fx = cvmGet(kalman.x, 0, 0);
    *fy = cvmGet(kalman.x, 1, 0);
}

<span class="keywordtype">void</span> filter_array_average(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y, <span class="keywordtype">double</span> *fx, <span class="keywordtype">double</span> *fy) {
    <span class="keyword">static</span> <span class="keywordtype">bool</span> init=<span class="keyword">true</span>;
    <span class="keyword">static</span> <a name="_a6"></a><a class="code" href="classalvar_1_1_filter_array.html" title="Class for handling an array of filtered values.">FilterArray&lt;FilterAverage&gt;</a> fa(2);
    <span class="keywordflow">if</span> (init) {
        init=<span class="keyword">false</span>;
        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;2; i++) {
            fa[i].setWindowSize(30);
        }
    }
    *fx = fa[0].next(x);
    *fy = fa[1].next(y);
}

<span class="keyword">class </span>KalmanSensorOwn : <span class="keyword">public</span> <a name="_a7"></a><a class="code" href="classalvar_1_1_kalman_sensor_ekf.html" title="Extended Kalman Filter (EKF) sensor implementation.">KalmanSensorEkf</a> {
    <span class="keyword">virtual</span> <span class="keywordtype">void</span> h(CvMat *x_pred, CvMat *_z_pred) {
        <span class="keywordtype">double</span> x = cvmGet(x_pred, 0, 0);
        <span class="keywordtype">double</span> y = cvmGet(x_pred, 1, 0);
        <span class="keywordtype">double</span> dx = cvmGet(x_pred, 2, 0);
        <span class="keywordtype">double</span> dy = cvmGet(x_pred, 3, 0);
        cvmSet(_z_pred, 0, 0, x);
        cvmSet(_z_pred, 1, 0, y);
    }
<span class="keyword">public</span>:
    KalmanSensorOwn(<span class="keywordtype">int</span> _n, <span class="keywordtype">int</span> _m) : <a class="code" href="classalvar_1_1_kalman_sensor_ekf.html" title="Extended Kalman Filter (EKF) sensor implementation.">KalmanSensorEkf</a>(_n, _m) {}
};

<span class="keyword">class </span>KalmanOwn : <span class="keyword">public</span> <a name="_a8"></a><a class="code" href="classalvar_1_1_kalman_ekf.html" title="Extended Kalman Filter (EKF) implementation.">KalmanEkf</a> {
    <span class="keyword">virtual</span> <span class="keywordtype">void</span> f(CvMat *_x, CvMat *_x_pred, <span class="keywordtype">double</span> dt) {
        <span class="keywordtype">double</span> x = cvmGet(_x, 0, 0);
        <span class="keywordtype">double</span> y = cvmGet(_x, 1, 0);
        <span class="keywordtype">double</span> dx = cvmGet(_x, 2, 0);
        <span class="keywordtype">double</span> dy = cvmGet(_x, 3, 0);
        cvmSet(_x_pred, 0, 0, x + dt*dx);
        cvmSet(_x_pred, 1, 0, y + dt*dy);
        cvmSet(_x_pred, 2, 0, dx);
        cvmSet(_x_pred, 3, 0, dy);
    }
<span class="keyword">public</span>:
    KalmanOwn(<span class="keywordtype">int</span> _n) : <a class="code" href="classalvar_1_1_kalman_ekf.html" title="Extended Kalman Filter (EKF) implementation.">KalmanEkf</a>(_n) {}
};

<span class="keywordtype">void</span> filter_ekf(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y, <span class="keywordtype">double</span> *fx, <span class="keywordtype">double</span> *fy) {
    <span class="keyword">static</span> <span class="keywordtype">bool</span> init=<span class="keyword">true</span>;
    <span class="keyword">static</span> KalmanSensorOwn sensor(4,2); 
    <span class="keyword">static</span> KalmanOwn kalman(4); <span class="comment">// x, y, dx, dy</span>
    <span class="keywordflow">if</span> (init) {
        init = <span class="keyword">false</span>;
        <span class="comment">// R</span>
        cvSetIdentity(sensor.R, cvScalar(100));
        <span class="comment">// Q</span>
        cvmSet(kalman.Q, 0, 0, 0.001);
        cvmSet(kalman.Q, 1, 1, 0.001);
        cvmSet(kalman.Q, 2, 2, 0.01);
        cvmSet(kalman.Q, 3, 3, 0.01);
        <span class="comment">// P</span>
        cvSetIdentity(kalman.P, cvScalar(100));
    }
    cvmSet(sensor.z, 0, 0, x);
    cvmSet(sensor.z, 1, 0, y);
    kalman.predict_update(&amp;sensor, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(cv::getTickCount() / cv::getTickFrequency() * 1000));
    *fx = cvmGet(kalman.x, 0, 0);
    *fy = cvmGet(kalman.x, 1, 0);
}

<span class="comment">//Make list of filters</span>
<span class="keyword">const</span> <span class="keywordtype">int</span> nof_filters = 8;
void (*(filters[nof_filters]))(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y, <span class="keywordtype">double</span> *fx, <span class="keywordtype">double</span> *fy) = {
    filter_none,
    filter_average,
    filter_median,
    filter_running_average,
    filter_des,
    filter_kalman,
    filter_ekf,
    filter_array_average,
};
<span class="keywordtype">char</span> filter_names[nof_filters][64]={
    <span class="stringliteral">&quot;No filter - Press any key to change&quot;</span>,
    <span class="stringliteral">&quot;Average&quot;</span>,
    <span class="stringliteral">&quot;Median&quot;</span>,
    <span class="stringliteral">&quot;Running Average&quot;</span>,
    <span class="stringliteral">&quot;Double Exponential Smoothing&quot;</span>,
    <span class="stringliteral">&quot;Kalman&quot;</span>,
    <span class="stringliteral">&quot;Extended Kalman&quot;</span>,
    <span class="stringliteral">&quot;Array (average)&quot;</span>
};

<span class="comment">// Just generate some random data that can be used as sensor input</span>
<span class="keywordtype">void</span> get_measurement(<span class="keywordtype">double</span> *x, <span class="keywordtype">double</span> *y) {
    <span class="keyword">static</span> <span class="keywordtype">double</span> xx=0;
    <span class="keyword">static</span> <span class="keywordtype">double</span> yy=0;
    <span class="keyword">static</span> <span class="keywordtype">double</span> dxx = 0.3;
    <span class="keyword">static</span> <span class="keywordtype">double</span> dyy = 0.7;
    xx += dxx; yy += dyy;
    <span class="keywordflow">if</span> ((xx &gt; res) || (xx &lt; 0)) dxx = -dxx;
    <span class="keywordflow">if</span> ((yy &gt; res) || (yy &lt; 0)) dyy = -dyy;
    <span class="keywordtype">double</span> rx = (rand()*20.0/RAND_MAX)-10.0;
    <span class="keywordtype">double</span> ry = (rand()*20.0/RAND_MAX)-10.0;

    <span class="comment">// Add some outliers</span>
    <span class="keywordflow">if</span>(fabs(rx*ry)&gt;50)
    {
        rx *= 5;
        ry *= 5;
    }

    *x = xx + rx; *y = yy + ry;
}

<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
{
    <span class="keywordflow">try</span> {
        <span class="comment">// Output usage message</span>
        std::string filename(argv[0]);
        filename = filename.substr(filename.find_last_of(<span class="charliteral">&#39;\\&#39;</span>) + 1);
        std::cout &lt;&lt; <span class="stringliteral">&quot;SampleFilter&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;============&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;Description:&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;  This is an example of how to use the &#39;FilterAverage&#39;, &#39;FilterMedian&#39;,&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;  &#39;FilterRunningAverage&#39;, &#39;FilterDoubleExponentialSmoothing&#39;, &#39;Kalman&#39;&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;  &#39;KalmanEkf&#39; and &#39;FilterArray&#39; filtering classes. First the example&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;  shows unfiltered test data with outliers. The data is then filtered&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;  using the various filters. Press any key to cycle through the filters.&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;Usage:&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;  &quot;</span> &lt;&lt; filename &lt;&lt; std::endl;
        std::cout &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;Keyboard Shortcuts:&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;  any key: cycle through filters&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;  q: quit&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; std::endl;

        <span class="comment">// Processing loop</span>
        IplImage *img = cvCreateImage(cvSize(res, res), IPL_DEPTH_8U, 3);
        cvNamedWindow(<span class="stringliteral">&quot;SampleFilter&quot;</span>);
        CvFont font;
        cvInitFont(&amp;font, CV_FONT_HERSHEY_PLAIN, 1.0, 1.0);
        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii = 0; ii &lt; nof_filters; ii++) {
            <span class="keywordtype">int</span> key = 0;
            <span class="keywordtype">double</span> x, y;
            <span class="keywordtype">double</span> fx, fy;
            vector&lt;CvPoint&gt; tail;
            <span class="keywordflow">while</span> (1) {
                get_measurement(&amp;x, &amp;y);
                filters[ii](x, y, &amp;fx, &amp;fy);
                cvZero(img);
                cvPutText(img, filter_names[ii], cvPoint(3, res - 10), &amp;font, CV_RGB(255, 255, 255));
                cvCircle(img, cvPoint(<span class="keywordtype">int</span>(x), <span class="keywordtype">int</span>(y)), 2, CV_RGB(0, 255, 255));
                cvCircle(img, cvPoint(<span class="keywordtype">int</span>(x), <span class="keywordtype">int</span>(y)), 3, CV_RGB(255, 255, 255));
                CvPoint fp;
                fp.x = int(fx);
                fp.y = int(fy);
                tail.push_back(fp);
                <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iii = 0; iii &lt; tail.size(); iii++) {
                    cvCircle(img, tail[iii], 0, CV_RGB(255, 255, 0));
                }
                cvCircle(img, fp, 2, CV_RGB(255, 0, 255));
                cvShowImage(<span class="stringliteral">&quot;SampleFilter&quot;</span>, img);
                key = cvWaitKey(10);
                <span class="keywordflow">if</span> (key != -1) {
                    <span class="keywordflow">break</span>;
                }
            }
            <span class="keywordflow">if</span> (key == <span class="charliteral">&#39;q&#39;</span>) {
                <span class="keywordflow">break</span>;
            }
        }
        cvReleaseImage(&amp;img);
        <span class="keywordflow">return</span> 0;
    }
    <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;e) {
        std::cout &lt;&lt; <span class="stringliteral">&quot;Exception: &quot;</span> &lt;&lt; e.what() &lt;&lt; endl;
    }
    <span class="keywordflow">catch</span> (...) {
        std::cout &lt;&lt; <span class="stringliteral">&quot;Exception: unknown&quot;</span> &lt;&lt; std::endl;
    }
}
</pre></div> </div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Tue May 29 18:20:30 2012 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
