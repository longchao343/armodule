<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>SampleMultiMarkerBundle.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>SampleMultiMarkerBundle.cpp</h1><p>This is an example that automatically recognising <em>MultiMarker</em> setups using <em>MultiMarkerFiltered</em> and optimizes it with <em>MultiMarkerBundle</em>.</p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &quot;CvTestbed.h&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="_marker_detector_8h.html" title="This file implements a generic marker detector.">MarkerDetector.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="_multi_marker_bundle_8h.html" title="This file implements an algorithm to create a multi-marker field configuration.">MultiMarkerBundle.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="_multi_marker_initializer_8h.html" title="This file implements a initialization algorithm to create a multi-marker field configuration...">MultiMarkerInitializer.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="_pose_8h.html" title="This file implements a pose.">Pose.h</a>&quot;</span>
<span class="preprocessor">#include &quot;Shared.h&quot;</span>
<span class="keyword">using namespace </span>alvar;
<span class="keyword">using namespace </span>std;

<span class="keywordtype">int</span> visualize=1;
<span class="keyword">const</span> <span class="keywordtype">int</span> nof_markers = 8;
<span class="keyword">const</span> <span class="keywordtype">double</span> marker_size = 4;
<span class="keywordtype">bool</span> add_measurement=<span class="keyword">false</span>;
<span class="keywordtype">bool</span> optimize = <span class="keyword">false</span>;
<span class="keywordtype">bool</span> optimize_done = <span class="keyword">false</span>;
<a name="_a0"></a><a class="code" href="classalvar_1_1_marker_detector.html">MarkerDetector&lt;MarkerData&gt;</a> marker_detector;
std::stringstream calibrationFilename;

<a name="_a1"></a><a class="code" href="classalvar_1_1_multi_marker_initializer.html" title="Initializes multi marker by estimating their relative positions from one or more...">MultiMarkerInitializer</a> *multi_marker_init=NULL;
<a name="_a2"></a><a class="code" href="classalvar_1_1_multi_marker_bundle.html" title="Multi marker that uses bundle adjustment to refine the 3D positions of the markers...">MultiMarkerBundle</a> *multi_marker_bundle=NULL;
<span class="keywordtype">double</span> GetMultiMarkerPose(IplImage *image, <a name="_a3"></a><a class="code" href="classalvar_1_1_camera.html" title="Simple Camera class for calculating distortions, orientation or projections with...">Camera</a> *cam, <a name="_a4"></a><a class="code" href="classalvar_1_1_pose.html" title="Pose representation derived from the Rotation class">Pose</a> &amp;pose) {
    <span class="keyword">static</span> <span class="keywordtype">bool</span> init=<span class="keyword">true</span>;
    <span class="keywordflow">if</span> (init) {
        cout&lt;&lt;<span class="stringliteral">&quot;Using manual multimarker approach with MultiMarkerInitializer &amp; MultiMarkerBundle.&quot;</span>&lt;&lt;endl;
        cout&lt;&lt;<span class="stringliteral">&quot;Use &#39;p&#39; for taking keyframes and &#39;o&#39; for optimizing.&quot;</span>&lt;&lt;endl;
        init=<span class="keyword">false</span>;
        vector&lt;int&gt; id_vector;
        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; nof_markers; ++i)
            id_vector.push_back(i);
        <span class="comment">// We make the initialization for MultiMarkerBundle using MultiMarkerInitializer</span>
        <span class="comment">// Each marker needs to be visible in at least two images and at most 64 image are used.</span>
        multi_marker_init = <span class="keyword">new</span> <a class="code" href="classalvar_1_1_multi_marker_initializer.html" title="Initializes multi marker by estimating their relative positions from one or more...">MultiMarkerInitializer</a>(id_vector, 2, 64);
        pose.<a name="a5"></a><a class="code" href="classalvar_1_1_pose.html#a372de693ad40b3f42839c8ec6ac845f4">Reset</a>();
        multi_marker_init-&gt;<a name="a6"></a><a class="code" href="classalvar_1_1_multi_marker.html#a9fd9c490537355aca9d21632004c474a" title="Adds marker corners to 3D point cloud of multi marker.">PointCloudAdd</a>(id_vector[0], marker_size, pose);
        multi_marker_bundle = <span class="keyword">new</span> <a class="code" href="classalvar_1_1_multi_marker_bundle.html" title="Multi marker that uses bundle adjustment to refine the 3D positions of the markers...">MultiMarkerBundle</a>(id_vector);
    }

    <span class="keywordtype">double</span> error = -1;
    <span class="keywordflow">if</span> (!optimize_done) {
        <span class="keywordflow">if</span> (marker_detector.<a name="a7"></a><a class="code" href="classalvar_1_1_marker_detector_impl.html#a3dd4b21464c6f1ac063f4f747a99040c" title="Detect Marker &amp;#39;s from image ">Detect</a>(image, cam, <span class="keyword">true</span>, (visualize == 1), 0.0)) {
            <span class="keywordflow">if</span> (visualize == 2)
                error = multi_marker_init-&gt;<a name="a8"></a><a class="code" href="classalvar_1_1_multi_marker.html#a36969143477ba06078bb1a7b9442d3e8" title="Calls GetPose to obtain camera pose.">Update</a>(marker_detector.<a name="a9"></a>markers, cam, pose, image);
            <span class="keywordflow">else</span>
                error = multi_marker_init-&gt;<a class="code" href="classalvar_1_1_multi_marker.html#a36969143477ba06078bb1a7b9442d3e8" title="Calls GetPose to obtain camera pose.">Update</a>(marker_detector.markers, cam, pose);
        }
    } <span class="keywordflow">else</span> {
        <span class="keywordflow">if</span> (marker_detector.<a class="code" href="classalvar_1_1_marker_detector_impl.html#a3dd4b21464c6f1ac063f4f747a99040c" title="Detect Marker &amp;#39;s from image ">Detect</a>(image, cam, <span class="keyword">true</span>, (visualize == 1), 0.0)) {
            <span class="keywordflow">if</span> (visualize == 2)
                error = multi_marker_bundle-&gt;<a class="code" href="classalvar_1_1_multi_marker.html#a36969143477ba06078bb1a7b9442d3e8" title="Calls GetPose to obtain camera pose.">Update</a>(marker_detector.markers, cam, pose, image);
            <span class="keywordflow">else</span> 
                error = multi_marker_bundle-&gt;<a class="code" href="classalvar_1_1_multi_marker.html#a36969143477ba06078bb1a7b9442d3e8" title="Calls GetPose to obtain camera pose.">Update</a>(marker_detector.markers, cam, pose);
            <span class="keywordflow">if</span> ((multi_marker_bundle-&gt;<a name="a10"></a><a class="code" href="classalvar_1_1_multi_marker.html#aad0c8721211f2a06f9decc2811507116" title="Set new markers to be tracked for MarkerDetector Sometimes the MultiMarker implementation...">SetTrackMarkers</a>(marker_detector, cam, pose, image) &gt; 0) &amp;&amp;
                (marker_detector.<a name="a11"></a>DetectAdditional(image, cam, (visualize == 3)) &gt; 0))
            {
                <span class="keywordflow">if</span> (visualize == 3)
                    error = multi_marker_bundle-&gt;<a class="code" href="classalvar_1_1_multi_marker.html#a36969143477ba06078bb1a7b9442d3e8" title="Calls GetPose to obtain camera pose.">Update</a>(marker_detector.markers, cam, pose, image);
                <span class="keywordflow">else</span>
                    error = multi_marker_bundle-&gt;<a class="code" href="classalvar_1_1_multi_marker.html#a36969143477ba06078bb1a7b9442d3e8" title="Calls GetPose to obtain camera pose.">Update</a>(marker_detector.markers, cam, pose);
            }
        }
    }

    <span class="keywordflow">if</span> (add_measurement) {
        <span class="keywordflow">if</span> (marker_detector.markers-&gt;size() &gt;= 2) {
            cout&lt;&lt;<span class="stringliteral">&quot;Adding measurement...&quot;</span>&lt;&lt;endl;
            multi_marker_init-&gt;<a name="a12"></a>MeasurementsAdd(marker_detector.markers);
            add_measurement=<span class="keyword">false</span>;
        }
    }

    <span class="keywordflow">if</span> (optimize) {
        cout&lt;&lt;<span class="stringliteral">&quot;Initializing...&quot;</span>&lt;&lt;endl;
        <span class="keywordflow">if</span> (!multi_marker_init-&gt;<a name="a13"></a><a class="code" href="classalvar_1_1_multi_marker_initializer.html#a7cf22da48dd95d2bbba7ab10751e4d5a">Initialize</a>(cam)) {
            cout&lt;&lt;<span class="stringliteral">&quot;Initialization failed, add some more measurements.&quot;</span>&lt;&lt;endl;

        } <span class="keywordflow">else</span> {
            <span class="comment">// Reset the bundle adjuster.</span>
            multi_marker_bundle-&gt;<a name="a14"></a><a class="code" href="classalvar_1_1_multi_marker.html#a4c4ba0ffe635d14b93794268bd8e5995" title="Resets the multi marker.">Reset</a>();
            multi_marker_bundle-&gt;<a name="a15"></a><a class="code" href="classalvar_1_1_multi_marker_bundle.html#ab9c1c129bfeccab9f20814c153bd11bb" title="Resets the measurements and camera poses that are stored for bundle adjustment. If...">MeasurementsReset</a>();
            <span class="comment">// Copy all measurements into the bundle adjuster.</span>
            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; multi_marker_init-&gt;<a name="a16"></a>getMeasurementCount(); ++i) {
                <a class="code" href="classalvar_1_1_pose.html" title="Pose representation derived from the Rotation class">Pose</a> pose;
                multi_marker_init-&gt;<a name="a17"></a>getMeasurementPose(i, cam, pose);
                <span class="keyword">const</span> std::vector&lt;MultiMarkerInitializer::MarkerMeasurement&gt; markers 
                    = multi_marker_init-&gt;<a name="a18"></a>getMeasurementMarkers(i);
                multi_marker_bundle-&gt;<a name="a19"></a><a class="code" href="classalvar_1_1_multi_marker_bundle.html#a27eafb46b0e8095fd5a9a554954b737b" title="Adds new measurements that are used in bundle adjustment.">MeasurementsAdd</a>(&amp;markers, pose);
            }
            <span class="comment">// Initialize the bundle adjuster with initial marker poses.</span>
            multi_marker_bundle-&gt;<a name="a20"></a><a class="code" href="classalvar_1_1_multi_marker.html#a1db87aa5140408e9a3f36dfb06f25379" title="Copies the 3D point cloud from other multi marker object.">PointCloudCopy</a>(multi_marker_init);
            cout&lt;&lt;<span class="stringliteral">&quot;Optimizing...&quot;</span>&lt;&lt;endl;
            <span class="keywordflow">if</span> (multi_marker_bundle-&gt;<a name="a21"></a><a class="code" href="classalvar_1_1_multi_marker_bundle.html#aaf1824edf477ed2f9dbc6886ce5e4ac3" title="Runs the bundle adjustment optimization.">Optimize</a>(cam, 0.01, 20)) {
                cout&lt;&lt;<span class="stringliteral">&quot;Optimizing done&quot;</span>&lt;&lt;endl;
                optimize_done=<span class="keyword">true</span>;

            } <span class="keywordflow">else</span> {
                cout&lt;&lt;<span class="stringliteral">&quot;Optimizing FAILED!&quot;</span>&lt;&lt;endl;
            }
        }
        optimize=<span class="keyword">false</span>;
    }
    <span class="keywordflow">return</span> error;
}

<span class="keywordtype">void</span> videocallback(IplImage *image)
{
    <span class="keyword">static</span> <a class="code" href="classalvar_1_1_camera.html" title="Simple Camera class for calculating distortions, orientation or projections with...">Camera</a> cam;
    <span class="keyword">static</span> <a class="code" href="classalvar_1_1_pose.html" title="Pose representation derived from the Rotation class">Pose</a> pose;
    <span class="keywordtype">bool</span> flip_image = (image-&gt;origin?<span class="keyword">true</span>:<span class="keyword">false</span>);
    <span class="keywordflow">if</span> (flip_image) {
        cvFlip(image);
        image-&gt;origin = !image-&gt;origin;
    }

    <span class="keyword">static</span> <span class="keywordtype">bool</span> init = <span class="keyword">true</span>;
    <span class="keywordflow">if</span> (init)
    {
        init = <span class="keyword">false</span>;

        <span class="comment">// Initialize camera</span>
        cout&lt;&lt;<span class="stringliteral">&quot;Loading calibration: &quot;</span>&lt;&lt;calibrationFilename.str();

        <span class="keywordflow">if</span> (cam.<a name="a22"></a><a class="code" href="classalvar_1_1_camera.html#a68c7b37ecfe0ab2e1d535e1c73f79ac6" title="Set the calibration file and the current resolution for which the calibration is...">SetCalib</a>(calibrationFilename.str().c_str(), image-&gt;width, image-&gt;height))
        {
            cout&lt;&lt;<span class="stringliteral">&quot; [Ok]&quot;</span>&lt;&lt;endl;
        }
        <span class="keywordflow">else</span>
        {
            cam.<a name="a23"></a><a class="code" href="classalvar_1_1_camera.html#a7156e68d6b50af62aef36e538964a7a8" title="If we have no calibration file we can still adjust the default calibration to current...">SetRes</a>(image-&gt;width, image-&gt;height);
            cout&lt;&lt;<span class="stringliteral">&quot; [Fail]&quot;</span>&lt;&lt;endl;
        }

        marker_detector.<a name="a24"></a><a class="code" href="classalvar_1_1_marker_detector_impl.html#a50c32ad5689d098670dc3519b7f0f9f8">SetMarkerSize</a>(marker_size);
    }

    <span class="comment">// Manual approach (use &#39;p&#39; for taking keyframes and &#39;o&#39; for optimizing)</span>
    <span class="keywordtype">double</span> error = GetMultiMarkerPose(image, &amp;cam, pose);

    <span class="comment">// Visualize a blue marker at the origo.</span>
    <span class="keyword">static</span> <a name="_a25"></a><a class="code" href="classalvar_1_1_marker.html" title="Basic 2D Marker functionality.">Marker</a> foo;
    foo.<a name="a26"></a><a class="code" href="classalvar_1_1_marker.html#a398e2cc0b89ba03dcba1d6935237fb6b" title="Method for resizing the marker dimensions.">SetMarkerSize</a>(marker_size);
    <span class="keywordflow">if</span> ((error &gt;= 0) &amp;&amp; (error &lt; 5))
    {
        foo.<a name="a27"></a><a class="code" href="classalvar_1_1_marker.html#a6cef9464eeb5ace63256ef8c05a2e373" title="The current marker Pose.">pose</a> = pose;
    }
    foo.<a name="a28"></a><a class="code" href="classalvar_1_1_marker.html#ac87e8c227d531c936b83f6b8e43fb3d7" title="Visualize the marker.">Visualize</a>(image, &amp;cam, CV_RGB(0,0,255));

    <span class="keywordflow">if</span> (flip_image) {
        cvFlip(image);
        image-&gt;origin = !image-&gt;origin;
    }
}

<span class="keywordtype">int</span> keycallback(<span class="keywordtype">int</span> key)
{
    <span class="keyword">static</span> <span class="keywordtype">bool</span> fixed = <span class="keyword">false</span>;

    <span class="keywordflow">if</span>(key == <span class="charliteral">&#39;r&#39;</span>)
    {
        cout&lt;&lt;<span class="stringliteral">&quot;Reseting multi marker&quot;</span>&lt;&lt;endl;
            multi_marker_init-&gt;<a class="code" href="classalvar_1_1_multi_marker.html#a4c4ba0ffe635d14b93794268bd8e5995" title="Resets the multi marker.">Reset</a>();
            multi_marker_init-&gt;<a name="a29"></a>MeasurementsReset();
            multi_marker_bundle-&gt;<a class="code" href="classalvar_1_1_multi_marker.html#a4c4ba0ffe635d14b93794268bd8e5995" title="Resets the multi marker.">Reset</a>();
            multi_marker_bundle-&gt;<a class="code" href="classalvar_1_1_multi_marker_bundle.html#ab9c1c129bfeccab9f20814c153bd11bb" title="Resets the measurements and camera poses that are stored for bundle adjustment. If...">MeasurementsReset</a>();
            add_measurement = <span class="keyword">false</span>;
            optimize        = <span class="keyword">false</span>;
            optimize_done   = <span class="keyword">false</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(key == <span class="charliteral">&#39;v&#39;</span>)
    {
        visualize = (visualize+1)%3;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(key == <span class="charliteral">&#39;l&#39;</span>)
    {
        <span class="keywordflow">if</span>(multi_marker_bundle-&gt;<a name="a30"></a><a class="code" href="classalvar_1_1_multi_marker.html#abbd3152db0b483ba944dbc7114420ede" title="Loads multi marker configuration from a text file.">Load</a>(<span class="stringliteral">&quot;mmarker.xml&quot;</span>, <a name="a31"></a><a class="code" href="namespacealvar.html#a89021fa008d0a93e735361ed4f3b885fa564f979051988b03ce9a266ee69bbe04" title="XML file format.">FILE_FORMAT_XML</a>))
        {
            cout&lt;&lt;<span class="stringliteral">&quot;Multi marker loaded&quot;</span>&lt;&lt;endl;
            multi_marker_init-&gt;<a class="code" href="classalvar_1_1_multi_marker.html#a1db87aa5140408e9a3f36dfb06f25379" title="Copies the 3D point cloud from other multi marker object.">PointCloudCopy</a>(multi_marker_bundle);
            optimize_done = <span class="keyword">true</span>;
        }
        <span class="keywordflow">else</span>
            cout&lt;&lt;<span class="stringliteral">&quot;Cannot load multi marker&quot;</span>&lt;&lt;endl;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(key == <span class="charliteral">&#39;s&#39;</span>)
    {
        <span class="keywordflow">if</span>(multi_marker_bundle-&gt;<a name="a32"></a><a class="code" href="classalvar_1_1_multi_marker.html#aac80175f04344d8a13d6b34715ef02d1" title="Saves multi marker configuration to a text file.">Save</a>(<span class="stringliteral">&quot;mmarker.xml&quot;</span>, <a class="code" href="namespacealvar.html#a89021fa008d0a93e735361ed4f3b885fa564f979051988b03ce9a266ee69bbe04" title="XML file format.">FILE_FORMAT_XML</a>))
            cout&lt;&lt;<span class="stringliteral">&quot;Multi marker saved&quot;</span>&lt;&lt;endl;
        <span class="keywordflow">else</span>
            cout&lt;&lt;<span class="stringliteral">&quot;Cannot save multi marker&quot;</span>&lt;&lt;endl;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(key == <span class="charliteral">&#39;p&#39;</span>)
    {
        add_measurement=<span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(key == <span class="charliteral">&#39;o&#39;</span>)
    {
        optimize=<span class="keyword">true</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">return</span> key;

    <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
{
    <span class="keywordflow">try</span> {
        <span class="comment">// Output usage message</span>
        std::string filename(argv[0]);
        filename = filename.substr(filename.find_last_of(<span class="charliteral">&#39;\\&#39;</span>) + 1);
        std::cout &lt;&lt; <span class="stringliteral">&quot;SampleMultiMarkerBundle&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;=======================&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;Description:&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;  This is an example of how to use the &#39;MultiMarkerBundle&#39; class to&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;  automatically deduce and optimize &#39;MultiMarker&#39; setups.&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;Usage:&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;  &quot;</span> &lt;&lt; filename &lt;&lt; <span class="stringliteral">&quot; [device]&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;    device    integer selecting device from enumeration list (default 0)&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;              highgui capture devices are prefered&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;Keyboard Shortcuts:&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;  v: switch between three debug visualizations&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;  l: load marker configuration from mmarker.txt&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;  s: save marker configuration to mmarker.txt&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;  r: reset marker configuration&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;  p: add measurement&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;  o: optimize bundle&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; <span class="stringliteral">&quot;  q: quit&quot;</span> &lt;&lt; std::endl;
        std::cout &lt;&lt; std::endl;

        <span class="comment">// Initialise CvTestbed</span>
        CvTestbed::Instance().SetVideoCallback(videocallback);
        CvTestbed::Instance().SetKeyCallback(keycallback);

        <span class="comment">// Enumerate possible capture plugins</span>
        CaptureFactory::CapturePluginVector plugins = CaptureFactory::instance()-&gt;enumeratePlugins();
        <span class="keywordflow">if</span> (plugins.size() &lt; 1) {
            std::cout &lt;&lt; <span class="stringliteral">&quot;Could not find any capture plugins.&quot;</span> &lt;&lt; std::endl;
            <span class="keywordflow">return</span> 0;
        }

        <span class="comment">// Display capture plugins</span>
        std::cout &lt;&lt; <span class="stringliteral">&quot;Available Plugins: &quot;</span>;
        outputEnumeratedPlugins(plugins);
        std::cout &lt;&lt; std::endl;

        <span class="comment">// Enumerate possible capture devices</span>
        CaptureFactory::CaptureDeviceVector devices = CaptureFactory::instance()-&gt;enumerateDevices();
        <span class="keywordflow">if</span> (devices.size() &lt; 1) {
            std::cout &lt;&lt; <span class="stringliteral">&quot;Could not find any capture devices.&quot;</span> &lt;&lt; std::endl;
            <span class="keywordflow">return</span> 0;
        }

        <span class="comment">// Check command line argument for which device to use</span>
        <span class="keywordtype">int</span> selectedDevice = defaultDevice(devices);
        <span class="keywordflow">if</span> (argc &gt; 1) {
            selectedDevice = atoi(argv[1]);
        }
        <span class="keywordflow">if</span> (selectedDevice &gt;= (<span class="keywordtype">int</span>)devices.size()) {
            selectedDevice = defaultDevice(devices);
        }
        
        <span class="comment">// Display capture devices</span>
        std::cout &lt;&lt; <span class="stringliteral">&quot;Enumerated Capture Devices:&quot;</span> &lt;&lt; std::endl;
        outputEnumeratedDevices(devices, selectedDevice);
        std::cout &lt;&lt; std::endl;
        
        <span class="comment">// Create capture object from camera</span>
        <a name="_a33"></a><a class="code" href="classalvar_1_1_capture.html" title="Capture interface that plugins must implement.">Capture</a> *cap = CaptureFactory::instance()-&gt;createCapture(devices[selectedDevice]);
        std::string uniqueName = devices[selectedDevice].uniqueName();

        <span class="comment">// Handle capture lifecycle and start video capture</span>
        <span class="comment">// Note that loadSettings/saveSettings are not supported by all plugins</span>
        <span class="keywordflow">if</span> (cap) {
            std::stringstream settingsFilename;
            settingsFilename &lt;&lt; <span class="stringliteral">&quot;camera_settings_&quot;</span> &lt;&lt; uniqueName &lt;&lt; <span class="stringliteral">&quot;.xml&quot;</span>;
            calibrationFilename &lt;&lt; <span class="stringliteral">&quot;camera_calibration_&quot;</span> &lt;&lt; uniqueName &lt;&lt; <span class="stringliteral">&quot;.xml&quot;</span>;
            
            cap-&gt;<a name="a34"></a><a class="code" href="classalvar_1_1_capture.html#ad64c54ab3191981b2443c47007f38516" title="Starts the camera capture.">start</a>();
            cap-&gt;<a name="a35"></a><a class="code" href="classalvar_1_1_capture.html#a7128319289dbf3e2847252407a636bf6" title="Set the resolution.">setResolution</a>(640, 480);
            
            <span class="keywordflow">if</span> (cap-&gt;<a name="a36"></a><a class="code" href="classalvar_1_1_capture.html#a485254ebd020e4976fe6ee8fbe14c964" title="Load camera settings from a file.">loadSettings</a>(settingsFilename.str())) {
                std::cout &lt;&lt; <span class="stringliteral">&quot;Loading settings: &quot;</span> &lt;&lt; settingsFilename.str() &lt;&lt; std::endl;
            }

            std::stringstream title;
            title &lt;&lt; <span class="stringliteral">&quot;SampleMultiMarkerBundle (&quot;</span> &lt;&lt; cap-&gt;<a name="a37"></a><a class="code" href="classalvar_1_1_capture.html#acf46a70c9622fe7423877992d4cce3a8" title="The camera information associated to this capture object.">captureDevice</a>().<a name="a38"></a><a class="code" href="classalvar_1_1_capture_device.html#a11c32e9333ba254fb56e624f5f6fcade" title="The type of capture backend.">captureType</a>() &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>;

            CvTestbed::Instance().StartVideo(cap, title.str().c_str());

            <span class="keywordflow">if</span> (cap-&gt;<a name="a39"></a><a class="code" href="classalvar_1_1_capture.html#af0e390628a628c31dce4bc8f48f7b847" title="Save camera settings to a file.">saveSettings</a>(settingsFilename.str())) {
                std::cout &lt;&lt; <span class="stringliteral">&quot;Saving settings: &quot;</span> &lt;&lt; settingsFilename.str() &lt;&lt; std::endl;
            }

            cap-&gt;<a name="a40"></a><a class="code" href="classalvar_1_1_capture.html#a0efff8623a2fb79dad94a96dcf16d966" title="Stops the camera capture.">stop</a>();
            <span class="keyword">delete</span> cap;
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CvTestbed::Instance().StartVideo(0, argv[0])) {
        }
        <span class="keywordflow">else</span> {
            std::cout &lt;&lt; <span class="stringliteral">&quot;Could not initialize the selected capture backend.&quot;</span> &lt;&lt; std::endl;
        }

        <span class="keywordflow">return</span> 0;
    }
    <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;e) {
        std::cout &lt;&lt; <span class="stringliteral">&quot;Exception: &quot;</span> &lt;&lt; e.what() &lt;&lt; endl;
    }
    <span class="keywordflow">catch</span> (...) {
        std::cout &lt;&lt; <span class="stringliteral">&quot;Exception: unknown&quot;</span> &lt;&lt; std::endl;
    }
}
</pre></div> </div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Tue May 29 18:20:30 2012 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
