<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>SampleMarkerCreator.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>SampleMarkerCreator.cpp</h1><p>This is an example that demonstrates the generation of <em>MarkerData</em> markers and saving the image using <em>SaveMarkerImage</em>.</p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &quot;<a class="code" href="_multi_marker_8h.html" title="This file implements a multi-marker.">MultiMarker.h</a>&quot;</span>
<span class="preprocessor">#include &quot;highgui.h&quot;</span>
<span class="keyword">using namespace </span>std;
<span class="keyword">using namespace </span>alvar;

<span class="keyword">struct </span>State {
    IplImage *img;
    stringstream filename;
    <span class="keywordtype">double</span> minx, miny, maxx, maxy; <span class="comment">// top-left and bottom-right in pixel units</span>
    <a name="_a0"></a><a class="code" href="classalvar_1_1_multi_marker.html" title="Base class for using MultiMarker.">MultiMarker</a> multi_marker;

    <span class="comment">// General options</span>
    <span class="keywordtype">bool</span>   prompt;
    <span class="keywordtype">double</span> units;           <span class="comment">// how many pixels per one unit</span>
    <span class="keywordtype">double</span> marker_side_len; <span class="comment">// marker side len in current units</span>
    <span class="keywordtype">int</span>    marker_type;     <span class="comment">// 0:MarkerData, 1:ArToolkit</span>
    <span class="keywordtype">double</span> posx, posy;      <span class="comment">// The position of marker center in the given units</span>
    <span class="keywordtype">int</span>    content_res;
    <span class="keywordtype">double</span> margin_res;

    <span class="comment">// MarkerData specific options</span>
    MarkerData::MarkerContentType marker_data_content_type;
    <span class="keywordtype">bool</span>                          marker_data_force_strong_hamming;

    State() 
        : img(0),
          prompt(<span class="keyword">false</span>),
          units(96.0/2.54),      <span class="comment">// cm assuming 96 dpi</span>
          marker_side_len(9.0),  <span class="comment">// 9 cm</span>
          marker_type(0),
          posx(0), posy(0),
          content_res(0),        <span class="comment">// 0 uses default</span>
          margin_res(0.0),       <span class="comment">// 0.0 uses default (can be n*0.5)</span>
          marker_data_content_type(MarkerData::MARKER_CONTENT_TYPE_NUMBER),
          marker_data_force_strong_hamming(<span class="keyword">false</span>)
    {}
    ~State() {
        <span class="keywordflow">if</span> (img) cvReleaseImage(&amp;img);
    }
    <span class="keywordtype">void</span> AddMarker(<span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>) {
        <span class="keywordflow">if</span> (marker_type == 0) {
            <a name="_a1"></a><a class="code" href="classalvar_1_1_marker_data.html" title="MarkerData contains matrix of Hamming encoded data.">MarkerData</a> md(marker_side_len, content_res, margin_res);
            <span class="keywordtype">int</span> side_len = int(marker_side_len*units+0.5);
            <span class="keywordflow">if</span> (img == 0) {
                img = cvCreateImage(cvSize(side_len, side_len), IPL_DEPTH_8U, 1);
                filename.str(<span class="stringliteral">&quot;&quot;</span>);
                filename&lt;&lt;<span class="stringliteral">&quot;MarkerData&quot;</span>;
                minx = (posx*units) - (marker_side_len*units/2.0);
                miny = (posy*units) - (marker_side_len*units/2.0);
                maxx = (posx*units) + (marker_side_len*units/2.0);
                maxy = (posy*units) + (marker_side_len*units/2.0);
            } <span class="keywordflow">else</span> {
                <span class="keywordtype">double</span> new_minx = (posx*units) - (marker_side_len*units/2.0);
                <span class="keywordtype">double</span> new_miny = (posy*units) - (marker_side_len*units/2.0);
                <span class="keywordtype">double</span> new_maxx = (posx*units) + (marker_side_len*units/2.0);
                <span class="keywordtype">double</span> new_maxy = (posy*units) + (marker_side_len*units/2.0);
                <span class="keywordflow">if</span> (minx &lt; new_minx) new_minx = minx;
                <span class="keywordflow">if</span> (miny &lt; new_miny) new_miny = miny;
                <span class="keywordflow">if</span> (maxx &gt; new_maxx) new_maxx = maxx;
                <span class="keywordflow">if</span> (maxy &gt; new_maxy) new_maxy = maxy;
                IplImage *new_img = cvCreateImage(cvSize(<span class="keywordtype">int</span>(new_maxx-new_minx+0.5), <span class="keywordtype">int</span>(new_maxy-new_miny+0.5)), IPL_DEPTH_8U, 1);
                cvSet(new_img, cvScalar(255));
                CvRect roi = cvRect(<span class="keywordtype">int</span>(minx-new_minx+0.5), <span class="keywordtype">int</span>(miny-new_miny+0.5), img-&gt;width, img-&gt;height);
                cvSetImageROI(new_img, roi);
                cvCopy(img, new_img);
                cvReleaseImage(&amp;img);
                img = new_img;
                roi.x = int((posx*units) - (marker_side_len*units/2.0) - new_minx + 0.5); 
                roi.y = int((posy*units) - (marker_side_len*units/2.0) - new_miny + 0.5); 
                roi.width = int(marker_side_len*units+0.5); roi.height = int(marker_side_len*units+0.5);
                cvSetImageROI(img, roi);
                minx = new_minx; miny = new_miny;
                maxx = new_maxx; maxy = new_maxy;
            }
            <span class="keywordflow">if</span> (marker_data_content_type == MarkerData::MARKER_CONTENT_TYPE_NUMBER) {
                <span class="keywordtype">int</span> idi = atoi(<span class="keywordtype">id</span>);
                md.<a name="a2"></a><a class="code" href="classalvar_1_1_marker_data.html#a8fc48dcc4e8f1b0bcf1d1d4adfb78474" title="Updates the marker_content by &amp;quot;encoding&amp;quot; the given parameters.">SetContent</a>(marker_data_content_type, idi, 0);
                <span class="keywordflow">if</span> (filename.str().length()&lt;64) filename&lt;&lt;<span class="stringliteral">&quot;_&quot;</span>&lt;&lt;idi;

                <a name="_a3"></a><a class="code" href="classalvar_1_1_pose.html" title="Pose representation derived from the Rotation class">Pose</a> pose;
                pose.<a name="a4"></a><a class="code" href="classalvar_1_1_pose.html#a372de693ad40b3f42839c8ec6ac845f4">Reset</a>();
                pose.<a name="a5"></a><a class="code" href="classalvar_1_1_pose.html#a13b8ab1ef3b2f42b5836dd75ad71a37d">SetTranslation</a>(posx, -posy, 0);
                multi_marker.PointCloudAdd(idi, marker_side_len, pose);
            } <span class="keywordflow">else</span> {
                md.<a class="code" href="classalvar_1_1_marker_data.html#a8fc48dcc4e8f1b0bcf1d1d4adfb78474" title="Updates the marker_content by &amp;quot;encoding&amp;quot; the given parameters.">SetContent</a>(marker_data_content_type, 0, <span class="keywordtype">id</span>);
                <span class="keyword">const</span> <span class="keywordtype">char</span> *p = id;
                <span class="keywordtype">int</span> counter=0;
                filename&lt;&lt;<span class="stringliteral">&quot;_&quot;</span>;
                <span class="keywordflow">while</span>(*p) {
                    <span class="keywordflow">if</span> (!isalnum(*p)) filename&lt;&lt;<span class="stringliteral">&quot;_&quot;</span>;
                    <span class="keywordflow">else</span> filename&lt;&lt;(char)tolower(*p);
                    p++; counter++;
                    <span class="keywordflow">if</span> (counter &gt; 8) <span class="keywordflow">break</span>;
                }
            }
            md.<a name="a6"></a><a class="code" href="classalvar_1_1_marker.html#afafb179009b1e1a5a188bb9810296944" title="Draw the marker filling the ROI in the given image.">ScaleMarkerToImage</a>(img);
            cvResetImageROI(img);
        }
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (marker_type == 1) {
            <span class="comment">// Create and save MarkerArtoolkit marker (Note, that this doesn&#39;t support multi markers)</span>
            <a name="_a7"></a><a class="code" href="classalvar_1_1_marker_artoolkit.html" title="MarkerArtoolkit for using matrix markers similar with the ones used in ARToolkit...">MarkerArtoolkit</a> md(marker_side_len, content_res, margin_res);
            <span class="keywordtype">int</span> side_len = int(marker_side_len*units+0.5);
            <span class="keywordflow">if</span> (img != 0) cvReleaseImage(&amp;img);
            img = cvCreateImage(cvSize(side_len, side_len), IPL_DEPTH_8U, 1);
            filename.str(<span class="stringliteral">&quot;&quot;</span>);
            filename&lt;&lt;<span class="stringliteral">&quot;MarkerArtoolkit&quot;</span>;
            md.<a name="a8"></a><a class="code" href="classalvar_1_1_marker_artoolkit.html#a6bf67410549dd7fa50154fe259ec89b0" title="Updates the marker_content by &amp;quot;encoding&amp;quot; the given parameters.">SetContent</a>(atoi(<span class="keywordtype">id</span>));
            filename&lt;&lt;<span class="stringliteral">&quot;_&quot;</span>&lt;&lt;atoi(<span class="keywordtype">id</span>);
            md.<a class="code" href="classalvar_1_1_marker.html#afafb179009b1e1a5a188bb9810296944" title="Draw the marker filling the ROI in the given image.">ScaleMarkerToImage</a>(img);
        }
    }
    <span class="keywordtype">void</span> Save() {
        <span class="keywordflow">if</span> (img) {
            std::stringstream filenamexml;
            filenamexml&lt;&lt;filename.str()&lt;&lt;<span class="stringliteral">&quot;.xml&quot;</span>;
            filename&lt;&lt;<span class="stringliteral">&quot;.png&quot;</span>;
            std::cout&lt;&lt;<span class="stringliteral">&quot;Saving: &quot;</span>&lt;&lt;filename.str()&lt;&lt;std::endl;
            cvSaveImage(filename.str().c_str(), img);
            <span class="keywordflow">if</span> (multi_marker.Size() &gt; 1) {
                std::cout&lt;&lt;<span class="stringliteral">&quot;Saving: &quot;</span>&lt;&lt;filenamexml.str()&lt;&lt;std::endl;
                multi_marker.Save(filenamexml.str().c_str(), <a name="a9"></a><a class="code" href="namespacealvar.html#a89021fa008d0a93e735361ed4f3b885fa564f979051988b03ce9a266ee69bbe04" title="XML file format.">alvar::FILE_FORMAT_XML</a>);
            }
        }
    }
} st;

<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
{
    <span class="keywordflow">try</span> {
        <span class="keywordflow">if</span> (argc &lt; 2) st.prompt = <span class="keyword">true</span>;
        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i&lt;argc; i++) {
            <span class="keywordflow">if</span> (strcmp(argv[i],<span class="stringliteral">&quot;-f&quot;</span>) == 0) 
                st.marker_data_force_strong_hamming=<span class="keyword">true</span>;
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(argv[i],<span class="stringliteral">&quot;-1&quot;</span>) == 0) 
                st.marker_data_content_type = MarkerData::MARKER_CONTENT_TYPE_STRING;
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(argv[i],<span class="stringliteral">&quot;-2&quot;</span>) == 0) 
                st.marker_data_content_type = MarkerData::MARKER_CONTENT_TYPE_FILE;
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(argv[i],<span class="stringliteral">&quot;-3&quot;</span>) == 0) 
                st.marker_data_content_type = MarkerData::MARKER_CONTENT_TYPE_HTTP;
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(argv[i],<span class="stringliteral">&quot;-u&quot;</span>) == 0)
                st.units = atof(argv[++i]);
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(argv[i],<span class="stringliteral">&quot;-uin&quot;</span>) == 0)
                st.units = (96.0);
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(argv[i],<span class="stringliteral">&quot;-ucm&quot;</span>) == 0)
                st.units = (96.0/2.54);
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(argv[i],<span class="stringliteral">&quot;-s&quot;</span>) == 0)
                st.marker_side_len = atof(argv[++i]);
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(argv[i],<span class="stringliteral">&quot;-r&quot;</span>) == 0)
                st.content_res = atoi(argv[++i]);
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(argv[i],<span class="stringliteral">&quot;-m&quot;</span>) == 0)
                st.margin_res = atof(argv[++i]);
            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(argv[i],<span class="stringliteral">&quot;-a&quot;</span>) == 0)
                st.marker_type = 1;
            <span class="keywordflow">else</span> if (strcmp(argv[i],<span class="stringliteral">&quot;-p&quot;</span>) == 0)
                st.prompt = <span class="keyword">true</span>;
            <span class="keywordflow">else</span> if (strcmp(argv[i],<span class="stringliteral">&quot;-xy&quot;</span>) == 0) {
                st.posx = atof(argv[++i]);
                st.posy = atof(argv[++i]);
            }
            <span class="keywordflow">else</span> st.AddMarker(argv[i]);
        }

        <span class="comment">// Output usage message</span>
        <span class="keywordflow">if</span> (st.prompt) {
            std::string filename(argv[0]);
            filename = filename.substr(filename.find_last_of(<span class="charliteral">&#39;\\&#39;</span>) + 1);
            std::cout &lt;&lt; <span class="stringliteral">&quot;SampleMarkerCreator&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;===================&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;Description:&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;  This is an example of how to use the &#39;MarkerData&#39; and &#39;MarkerArtoolkit&#39;&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;  classes to generate marker images. This application can be used to&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;  generate markers and multimarker setups that can be used with&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;  SampleMarkerDetector and SampleMultiMarker.&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;Usage:&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;  &quot;</span> &lt;&lt; filename &lt;&lt; <span class="stringliteral">&quot; [options] argument&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;    65535             marker with number 65535&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;    -f 65535          force hamming(8,4) encoding&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;    -1 \&quot;hello world\&quot;  marker with string&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;    -2 catalog.xml    marker with file reference&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;    -3 www.vtt.fi     marker with URL&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;    -u 96             use units corresponding to 1.0 unit per 96 pixels&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;    -uin              use inches as units (assuming 96 dpi)&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;    -ucm              use cm&#39;s as units (assuming 96 dpi) &lt;default&gt;&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;    -s 5.0            use marker size 5.0x5.0 units (default 9.0x9.0)&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;    -r 5              marker content resolution -- 0 uses default&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;    -m 2.0            marker margin resolution -- 0 uses default&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;    -a                use ArToolkit style matrix markers&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; <span class="stringliteral">&quot;    -p                prompt marker placements interactively from the user&quot;</span> &lt;&lt; std::endl;
            std::cout &lt;&lt; std::endl;

            <span class="comment">// Interactive stuff here</span>
            <span class="keywordflow">if</span> (st.prompt) {
                st.marker_type = 0;
                st.marker_data_content_type = MarkerData::MARKER_CONTENT_TYPE_NUMBER;
                std::cout&lt;&lt;<span class="stringliteral">&quot;\nPrompt marker placements interactively&quot;</span>&lt;&lt;std::endl;
                std::cout&lt;&lt;<span class="stringliteral">&quot;  units: &quot;</span>&lt;&lt;st.units/96.0*2.54&lt;&lt;<span class="stringliteral">&quot; cm &quot;</span>&lt;&lt;st.units/96.0&lt;&lt;<span class="stringliteral">&quot; inches&quot;</span>&lt;&lt;std::endl;
                std::cout&lt;&lt;<span class="stringliteral">&quot;  marker side: &quot;</span>&lt;&lt;st.marker_side_len&lt;&lt;<span class="stringliteral">&quot; units&quot;</span>&lt;&lt;std::endl;
                <span class="keywordtype">bool</span> loop=<span class="keyword">true</span>;
                std::string s;
                <span class="keywordtype">int</span> marker_id=0;
                <span class="keywordtype">double</span> posx=0.0, posy=0.0;
                <span class="keywordtype">bool</span> vert=<span class="keyword">false</span>;
                <span class="keywordflow">while</span>(loop) {
                    std::cout&lt;&lt;<span class="stringliteral">&quot;  marker id (use -1 to end) [&quot;</span>&lt;&lt;marker_id&lt;&lt;<span class="stringliteral">&quot;]: &quot;</span>; std::flush(std::cout);
                    std::getline(std::cin, s); <span class="keywordflow">if</span> (s.length() &gt; 0) marker_id=atoi(s.c_str());
                    <span class="keywordflow">if</span> (marker_id &lt; 0) <span class="keywordflow">break</span>;
                    std::cout&lt;&lt;<span class="stringliteral">&quot;  x position (in current units) [&quot;</span>&lt;&lt;posx&lt;&lt;<span class="stringliteral">&quot;]: &quot;</span>; std::flush(std::cout);
                    std::getline(std::cin, s); <span class="keywordflow">if</span> (s.length() &gt; 0) posx=atof(s.c_str());
                    std::cout&lt;&lt;<span class="stringliteral">&quot;  y position (in current units) [&quot;</span>&lt;&lt;posy&lt;&lt;<span class="stringliteral">&quot;]: &quot;</span>; std::flush(std::cout);
                    std::getline(std::cin, s); <span class="keywordflow">if</span> (s.length() &gt; 0) posy=atof(s.c_str());
                    st.posx=posx; st.posy=posy;
                    std::stringstream ss;
                    ss&lt;&lt;marker_id;
                    st.AddMarker(ss.str().c_str());

                    <span class="comment">// Guess suitable marker_id and placement for the next marker</span>
                    marker_id++;
                    <span class="keywordflow">if</span> (posx &lt;= 0) {
                        posx = int(sqrt(<span class="keywordtype">double</span>(marker_id)))*st.marker_side_len*2;
                        posy = 0;
                        vert = <span class="keyword">true</span>;
                    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vert) {
                        posy += (st.marker_side_len*2);
                        <span class="keywordflow">if</span> (posy &gt;= posx) vert = <span class="keyword">false</span>;
                    } <span class="keywordflow">else</span> {
                        posx -= (st.marker_side_len*2);
                    }
                }
            }
        }
        st.Save();
        <span class="keywordflow">return</span> 0;
    }
    <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;e) {
        std::cout &lt;&lt; <span class="stringliteral">&quot;Exception: &quot;</span> &lt;&lt; e.what() &lt;&lt; endl;
    }
    <span class="keywordflow">catch</span> (...) {
        std::cout &lt;&lt; <span class="stringliteral">&quot;Exception: unknown&quot;</span> &lt;&lt; std::endl;
    }
}
</pre></div> </div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Tue May 29 18:20:30 2012 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
